<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Bill Scanner + Gemini AI + Google Sheets</title>
    <style>
        /* ===== Reset & Base ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f4f7fb 0%, #e8ecf4 100%);
            color: #333;
            padding: 2rem;
            line-height: 1.6;
        }

        /* ===== Container ===== */
        .container {
            max-width: 850px;
            margin: auto;
            background: #fff;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease;
        }

        /* ===== Headings ===== */
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        h3 {
            margin-bottom: 0.75rem;
            color: #333;
            font-weight: 600;
        }

        /* ===== Inputs & Textareas ===== */
        textarea, input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d1d9e6;
            border-radius: 8px;
            box-sizing: border-box;
            margin-top: 6px;
            background-color: #fafbfc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        textarea:focus, input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
            outline: none;
        }

        /* ===== Buttons ===== */
        button {
            background: linear-gradient(90deg, #1a73e8, #0f5bb5);
            color: white;
            padding: 14px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            margin-bottom: 14px; /* ✅ extra bottom margin */
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        button:disabled { background: #c5c8cc; cursor: not-allowed; }
        button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,115,232,0.3); }

        .auth-buttons button {
            background: linear-gradient(90deg, #34a853, #2a7b3b);
            width: calc(50% - 6px);
            display: inline-block;
        }
        .auth-buttons button:hover:not(:disabled) { box-shadow: 0 4px 12px rgba(52,168,83,0.3); }
        .auth-buttons { display: flex; gap: 12px; }

        /* ===== Status Alerts ===== */
        .error, .success, .info {
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 14px;
        }
        .error { background: #fdecea; color: #d93025; border: 1px solid #f5c2c0; }
        .success { background: #e6f4ea; color: #137333; border: 1px solid #b7dfb9; }
        .info { background: #e8f0fe; color: #0b5394; border: 1px solid #c2dbff; }

        /* ===== Loader ===== */
        #loader { display: none; text-align: center; margin: 20px 0; }
        .spinner {
            border: 4px solid #e6e6e6;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== JSON Output ===== */
        .json-output {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #d1d9e6;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 14px;
        }

        /* ===== Table ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        td {
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        tr:last-child td { border-bottom: none; }
        tr td:first-child { font-weight: 600; color: #444; }

        /* ===== Animation ===== */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }
    </style>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google API Libraries -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- START: REQUIRED KEYS (REPLACE THESE IF YOU HAVEN'T) ---
        // Make sure these keys are correct
        const GEMINI_API_KEY = "AIzaSyCDEGN1ZXXVda9yhp2bHhpzT5yncr66CKY"; // <--- ⚠️ PASTE YOUR GEMINI API KEY HERE
        const GOOGLE_CLOUD_API_KEY = "AIzaSyBzpd32TmhuLyFjZ7t3J4__KuY7c3Gm-P0"; // <--- ⚠️ PASTE YOUR GOOGLE CLOUD API KEY HERE
        const GOOGLE_CLIENT_ID = '316419019852-4dum2avurto1fv23lm0mrehl6pa8k103.apps.googleusercontent.com'; // <--- ⚠️ PASTE YOUR NEW CLIENT ID HERE
        const SPREADSHEET_ID = '1j359MdhUs9mScAnC7T0fB33LAZY2F_WISLxAbgGnHDM';
        // --- END: REQUIRED KEYS ---

        // This script block is now in the HEAD so functions are defined before they are called.
        
        // --- Google Sheets Integration ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_CLOUD_API_KEY,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });
                gapiInited = true;
                maybeEnableAuthButtons();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
                document.getElementById('status-area').innerHTML = `<div class="error">Could not initialize Google API. Check your Google Cloud API Key and ensure the Google Sheets API is enabled.</div>`;
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    callback: '', // Will be set dynamically
                });
                gisInited = true;
                maybeEnableAuthButtons();
            } catch (error) {
                console.error("Error initializing GIS client:", error);
                document.getElementById('status-area').innerHTML = `<div class="error">Could not initialize Google Sign-In. Check your Google Client ID and OAuth configuration in the Cloud Console.</div>`;
            }
        }
        
        function maybeEnableAuthButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.visibility = 'visible';
            }
        }
        
        function maybeEnableGetDataButton() {
            // This function might be called before gapi.client is ready.
            if (gapi && gapi.client && typeof gapi.client.getToken === 'function') {
                const hasToken = gapi.client.getToken() !== null;
                const hasText = document.getElementById('extracted-text-output').value.trim() !== "";
                document.getElementById('get-data-btn').disabled = !(hasToken && hasText);
            }
        }

        function handleAuthClick() {
            if (!tokenClient) {
                console.error("Token client not initialized.");
                return;
            }
            tokenClient.callback = (resp) => {
                if (resp.error !== undefined) {
                    console.error("Auth Error:", resp);
                    throw(resp);
                }
                document.getElementById('signout_button').style.visibility = 'visible';
                document.getElementById('authorize_button').innerText = 'Refresh Token';
                showStatus('success', 'Authorization successful! You can now process the bill.');
                maybeEnableGetDataButton();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('signout_button').style.visibility = 'hidden';
                document.getElementById('authorize_button').innerText = 'Authorize Google Sheets';
                document.getElementById('get-data-btn').disabled = true;
                showStatus('info', 'You have been signed out.');
            }
        }
    </script>
</head>
<body>

    <div class="container">
        <h1>📄 PDF Bill Scanner + Gemini AI ➡️ Google Sheets</h1>
        <div class="file-uploader"><label for="pdf-upload"><b>1. Upload your PDF bill</b></label><input type="file" id="pdf-upload" accept=".pdf"></div>
        <div id="status-area"></div>
        <div id="extracted-text-section" style="display:none;"><h3>📜 Extracted Text</h3><textarea id="extracted-text-output" rows="10" readonly></textarea></div>
        <div class="manual-fields"><h3>📝 2. Additional Bill Details (Manual Entry)</h3><input type="text" id="bill-source" placeholder="Bill Source"><input type="text" id="bill-given-by" placeholder="Bill Given By"><input type="text" id="hod-approval" placeholder="HOD for Approval"><input type="text" id="final-approval" placeholder="Final Approval"></div>
        
        <div class="gemini-section">
            <h3>🤖 3. Process and Send to Google Sheets</h3>
            <div class="auth-buttons">
                <button id="authorize_button" style="visibility: hidden;">Authorize Google Sheets</button>
                <button id="signout_button" style="visibility: hidden;">Sign Out</button>
            </div>
            <button id="get-data-btn" disabled>Get Data & Add to Sheet</button>
            <!-- ✅ New button for multiple bills -->
            <button id="process-new-btn" style="display:none;background:linear-gradient(90deg,#f59e0b,#d97706);">Process New Bill</button>
        </div>

        <div id="loader"><div class="spinner"></div><p>Processing... Please wait.</p></div>
        <div id="results"></div>
        <div id="download-section" style="margin-top: 20px;"></div>
    </div>

    <script>
        // This script block now mainly deals with DOM manipulation and can stay here.
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;

        const pdfUpload = document.getElementById('pdf-upload');
        const getDataBtn = document.getElementById('get-data-btn');
        const extractedTextOutput = document.getElementById('extracted-text-output');
        const extractedTextSection = document.getElementById('extracted-text-section');
        const statusArea = document.getElementById('status-area');
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');
        const downloadSection = document.getElementById('download-section');
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const processNewBtn = document.getElementById('process-new-btn');

        // Attach event listeners now that the DOM is ready
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        
        let billData = []; // Stores data for Excel download

        const DEFAULT_PROMPT = `Scan this bill and tell me the following details in JSON format:
1. Name of the Vendor
2. Name of the company on which this bill has been raise
3. Nature of expense
4. Is TDS Applicable on this bill? If yes, what is the rate and amount?
5. Is GST under RCM applicable?
6. Is GST Input included in the bill?
7. Is the nature of IGST or CGST and SGST as per Place of Supply in GST correct?
8. What is the final amount payable to the vendor?
9. Are there any remarks mentioned in the bill?
Return ONLY valid JSON without any extra text, explanation, or markdown formatting.`;

        pdfUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            resultsDiv.innerHTML = '';
            downloadSection.innerHTML = '';
            extractedTextOutput.value = '';
            getDataBtn.disabled = true;
            extractedTextSection.style.display = 'block';
            processNewBtn.style.display = 'none';

            showStatus('info', 'Step 1: Reading PDF file...');
            const fileReader = new FileReader();

            fileReader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                let extractedText = "";
                try {
                    const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;
                    let textContent = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const text = await page.getTextContent();
                        if (text.items.length > 0) {
                            textContent += text.items.map(s => s.str).join(' ') + '\n';
                        }
                    }
                    extractedText = textContent.trim();

                    if (!extractedText) {
                        showStatus('info', 'No direct text found. Starting OCR... This may take a moment.');
                        let ocrText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            showStatus('info', `Processing Page ${i}/${pdf.numPages} with OCR...`);
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const imageDataUrl = canvas.toDataURL('image/png');
                            const worker = await Tesseract.createWorker('eng');
                            const { data: { text } } = await worker.recognize(imageDataUrl);
                            ocrText += text + '\n';
                            await worker.terminate();
                        }
                        extractedText = ocrText.trim();
                    }

                    if (extractedText) {
                        extractedTextOutput.value = extractedText;
                        showStatus('success', 'Text extracted! Please fill manual details and authorize Google Sheets.');
                        maybeEnableGetDataButton();
                    } else {
                        showStatus('error', 'Could not extract any text from the PDF.');
                    }
                } catch (error) {
                    console.error("Processing Error:", error);
                    showStatus('error', 'An error occurred while processing the PDF. Check console for details.');
                }
            };
            fileReader.readAsArrayBuffer(file);
        });

        getDataBtn.addEventListener('click', async () => {
            const billSource = document.getElementById('bill-source').value;
            const billGivenBy = document.getElementById('bill-given-by').value;
            const hodApproval = document.getElementById('hod-approval').value;
            const finalApproval = document.getElementById('final-approval').value;

            if (extractedTextOutput.value.trim() === "") { showStatus('error', 'Please upload a PDF and wait for text extraction.'); return; }
            if (!billSource || !billGivenBy || !hodApproval || !finalApproval) { showStatus('error', 'Please fill all manual fields.'); return; }

            loader.style.display = 'block';
            resultsDiv.innerHTML = '';
            downloadSection.innerHTML = '';
            loader.querySelector('p').innerText = "Processing with Gemini...";

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: `${DEFAULT_PROMPT}\n\nBill Text:\n${extractedTextOutput.value}` }] }] };

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : `API request failed with status ${response.status}`);
                }
                const data = await response.json();
                let geminiText = data.candidates[0].content.parts[0].text;
                const jsonMatch = geminiText.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const jsonString = jsonMatch[0];
                    const parsedData = JSON.parse(jsonString);
                    
                    parsedData["Bill Source"] = billSource;
                    parsedData["Bill Given By"] = billGivenBy;
                    parsedData["HOD Approval"] = hodApproval;
                    parsedData["Final Approval"] = finalApproval;

                    billData.push(parsedData); 
                    showStatus('success', 'Data Extracted from Gemini! Now sending to Google Sheets...', true);
                    displayDataAsTable(parsedData);
                    createDownloadButton();
                    
                    loader.querySelector('p').innerText = "Sending data to Google Sheets...";
                    await appendToSheet(parsedData);

                } else {
                    showStatus('error', 'No valid JSON object found in Gemini response.', true);
                    resultsDiv.innerHTML = `<pre class="json-output">${geminiText}</pre>`;
                }
            } catch (error) {
                console.error('Gemini API/Processing Error:', error);
                showStatus('error', `Error: ${error.message}`, true);
            } finally {
                loader.style.display = 'none';
            }
        });
        
        async function appendToSheet(data) {
            // ✅ Upgraded: ensure correct columns by checking/creating headers, then mapping values by header order.
            let sheetRange = 'Sheet1';
            let headersFromData = Object.keys(data);

            try {
                // Read existing header row
                const getHeader = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: sheetRange + '!1:1',
                });

                // Existing headers in sheet (if any)
                let existingHeaders = getHeader.result.values ? getHeader.result.values[0] : [];

                // Add any missing headers from incoming data
                let updateNeeded = false;
                headersFromData.forEach(h => {
                    if (!existingHeaders.includes(h)) {
                        existingHeaders.push(h);
                        updateNeeded = true;
                    }
                });

                // If no header row existed, or we added new headers, write header row back
                if (updateNeeded || existingHeaders.length === 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: sheetRange + '!1:1',
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [existingHeaders] }
                    });
                }

                // Order the row values according to existingHeaders to ensure correct columns
                const orderedRow = existingHeaders.map(h => (h in data ? data[h] : ''));

                // Append the ordered row
                const appendResult = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: sheetRange,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: [orderedRow] }
                });

                console.log('Sheet append result:', appendResult);
                showStatus('success', `Data successfully added to Google Sheet! View it <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/" target="_blank">here</a>.`, true);

                // ✅ Show "Process New Bill" button for multi-bill workflow
                processNewBtn.style.display = 'block';

            } catch (err) {
                console.error('Error appending data to sheet:', err);
                let errorMessage = err.result?.error?.message || 'Could not add data to Google Sheet. Check console for details.';
                showStatus('error', errorMessage, true);
            }
        }

        // --- Helper Functions ---
        function displayDataAsTable(data) {
            let table = '<table>';
            for (const key in data) {
                 table += `<tr><td style="font-weight: bold; padding: 5px 15px 5px 5px; vertical-align: top;">${key}</td><td>${data[key]}</td></tr>`;
            }
            table += '</table>';
            resultsDiv.innerHTML = table;
        }

        function createDownloadButton() {
            const button = document.createElement('button');
            button.innerText = 'Download All Extracted Data (Excel)';
            button.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)'; // Orange gradient
            button.onclick = () => {
                if (billData.length === 0) { alert("No data to download."); return; }
                const worksheet = XLSX.utils.json_to_sheet(billData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Bills");
                XLSX.writeFile(workbook, "bill_data.xlsx");
            };
            downloadSection.innerHTML = '';
            downloadSection.appendChild(button);
        }

        function showStatus(type, message, isResult = false) {
            const targetDiv = isResult ? resultsDiv : statusArea;
            targetDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // ✅ "Process New Bill" => reset UI for next file
        function resetForNewBill() {
            pdfUpload.value = "";
            extractedTextOutput.value = "";
            document.getElementById('bill-source').value = "";
            document.getElementById('bill-given-by').value = "";
            document.getElementById('hod-approval').value = "";
            document.getElementById('final-approval').value = "";
            resultsDiv.innerHTML = "";
            statusArea.innerHTML = "";
            downloadSection.innerHTML = "";
            extractedTextSection.style.display = 'none';
            getDataBtn.disabled = true;
            processNewBtn.style.display = 'none';
            showStatus('info', 'Ready for the next bill. Upload a PDF to begin.');
        }

        processNewBtn.addEventListener('click', resetForNewBill);
    </script>
</body>
</html>
